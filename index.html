<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The World in Conflict</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; background: #0f112f; }
    .twic-hud {
      position:absolute; left:8px; bottom:8px; z-index:1000;
      background:#ffffffd9; padding:6px 10px; border-radius:8px;
      font:12px/1.2 system-ui,sans-serif; box-shadow:0 2px 8px rgba(0,0,0,.15);
    }

    /* Region label style */
    .twic-label {
      font:600 12px/1.2 system-ui,sans-serif; color:#111; background:#fff;
      border:1px solid #e5e7eb; border-radius:6px; padding:3px 6px;
      box-shadow:0 1px 6px rgba(0,0,0,.15);
    }

    /* Measurement label badges */
    .twic-badge {
      font:600 12px/1.2 system-ui,sans-serif; color:#111; background:#fff;
      border:1px solid #e5e7eb; border-radius:6px; padding:3px 6px;
      box-shadow:0 1px 6px rgba(0,0,0,.15);
    }

    /* Simple toolbar for measure controls */
    .twic-toolbar {
      position:absolute; right:8px; top:8px; z-index:1000; display:flex; gap:6px;
    }
    .twic-btn {
      background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:6px 10px;
      font:12px system-ui; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    .twic-btn.active { background:#111827; color:#fff; border-color:#111827; }
  </style>
</head>
<body>
<div id="map"></div>
  <div class="twic-hud" id="twicHud">X,Y: â€”, â€” | Zoom: â€” | 1 px = â€”</div>
  <div class="twic-toolbar">
    <button class="twic-btn" id="measureBtn" title="Click start â†’ click end â†’ Esc to cancel">Measure</button>
    <button class="twic-btn" id="clearBtn">Clear</button>
  </div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // Zoom levels 0â€“7 (per your gdal2tiles command)
  const MAX_ZOOM = 7;

  // You produced PNG tiles and used --xyz (not TMS)
  const TILE_URL = './tiles/{z}/{x}/{y}.png';

  // Initialize map using simple pixel coordinate system
  const map = L.map('map', {
    crs: L.CRS.Simple,
    minZoom: 0,
    maxZoom: MAX_ZOOM,
    zoom: 0,
    center: [-56, 128],
    updateWhenIdle: true,
    zoomAnimation: true
  });

  // Add base tiles
  L.tileLayer(TILE_URL, {
    tileSize: 256,
    minZoom: 0,
    maxZoom: MAX_ZOOM,
    noWrap: true,
    detectRetina: true,
    keepBuffer: 2
  }).addTo(map);

  map.flyTo([-56, 128], 2, {        // <- immediately fly to your target
    animate: true,
    duration: 1.5,
    easeLinearity: 0.25
  })

// ===========================================================================
// MODULE 1: Coordinates HUD (live X/Y + zoom + custom scale)
// ===========================================================================

 const UNITS_PER_PIXEL = 30;
 const UNIT_NAME = 'km';

 function addCoordinateHUD(map, opts={}) {
    const hud = document.getElementById(opts.elId || 'twicHud');
    const unitsPerPixel = opts.unitsPerPixel ?? null;
    const unitName = opts.unitName ?? 'units';

    function render(e) {
      const z = map.getZoom();
      const p = e && e.latlng ? e.latlng : map.getCenter();
      const xy = `X,Y: ${p.lng.toFixed(0)}, ${p.lat.toFixed(0)}`;
      const zoom = `Zoom: ${z}`;
      const scale = (unitsPerPixel != null) ? ` | 1 px = ${unitsPerPixel} ${unitName}` : '';
      hud.textContent = `${xy} | ${zoom}${scale}`;
    }
    map.on('mousemove zoomend moveend', render);
    render();
  }
  addCoordinateHUD(map, { unitsPerPixel: UNITS_PER_PIXEL, unitName: UNIT_NAME });
  
// ===========================================================================
// MODULE 4: Measurement Tool (click-to-measure, Esc to cancel)
// ===========================================================================
  function addMeasureTool(map, options={}) {
    const unitsPerPixel = options.unitsPerPixel ?? 1;
    const unitName = options.unitName ?? 'units';
    const lineStyle  = Object.assign({ color:'#111827', weight:3 }, options.lineStyle||{});
    const guideStyle = Object.assign({ color:'#111827', weight:2, dashArray:'5,4' }, options.guideStyle||{});

    let active = false, start = null, guide = null;
    const group = L.layerGroup().addTo(map);

    function pxDist(a, b) {
      const dx = b.lng - a.lng, dy = b.lat - a.lat;
      return Math.hypot(dx, dy);
    }
    function fmt(px) {
      const v = px * unitsPerPixel;
      if (unitName === 'm' && v >= 1000) return (v/1000).toFixed(2) + ' km';
      return v.toFixed(2) + ' ' + unitName;
    }
    function begin() {
      active = true; start = null;
      map.getContainer().style.cursor = 'crosshair';
    }
    function cancel() {
      active = false; start = null;
      if (guide) { map.removeLayer(guide); guide = null; }
      map.getContainer().style.cursor = '';
    }
    function clearAll() {
      group.clearLayers(); cancel();
    }

    map.on('click', e => {
      if (!active) return;
      if (!start) {
        start = e.latlng;
        guide = L.polyline([start,start], guideStyle).addTo(map);
      } else {
        const end = e.latlng;
        const dpx = pxDist(start, end);
        L.polyline([start,end], lineStyle).addTo(group);
        const mid = L.latLng((start.lat+end.lat)/2, (start.lng+end.lng)/2);
        L.marker(mid, {
          icon: L.divIcon({ className:'twic-badge', html: fmt(dpx), iconSize:null }),
          interactive:false
        }).addTo(group);
        cancel();
      }
    });
    map.on('mousemove', e => { if (active && guide && start) guide.setLatLngs([start, e.latlng]); });
    map.on('keydown', e => { if (e.originalEvent.key === 'Escape') cancel(); });

    return { start: begin, cancel, clear: clearAll, layer: group };
  }

  // Wire up the measure tool to the buttons
  const measure = addMeasureTool(map, { unitsPerPixel: UNITS_PER_PIXEL, unitName: UNIT_NAME });
  document.getElementById('measureBtn').onclick = function() {
    this.classList.add('active');
    measure.start();
  };
  document.getElementById('clearBtn').onclick = function() {
    document.getElementById('measureBtn').classList.remove('active');
    measure.clear();
  };

</script>
</body>
</html>